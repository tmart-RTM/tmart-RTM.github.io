<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Instruction - Basic Modelling &mdash; T-Mart 2.0.8 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Instruction - Advanced Modelling" href="ins_advanced.html" />
    <link rel="prev" title="Overview" href="overview.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            T-Mart
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Instruction - Basic Modelling</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#quick-start">Quick Start</a></li>
<li class="toctree-l2"><a class="reference internal" href="#observing-the-movements-of-a-single-photon">Observing the Movements of a Single Photon</a></li>
<li class="toctree-l2"><a class="reference internal" href="#multiple-processing">Multiple Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#water-pixels">Water Pixels</a></li>
<li class="toctree-l2"><a class="reference internal" href="#modify-background">Modify Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adding-aerosol-to-the-atmosphere">Adding Aerosol to the Atmosphere</a></li>
<li class="toctree-l2"><a class="reference internal" href="#surface-properties">Surface Properties</a></li>
<li class="toctree-l2"><a class="reference internal" href="#band-calculation">Band Calculation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#other-parameters">Other Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#full-single-run">Full Single Run</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ins_advanced.html">Instruction - Advanced Modelling</a></li>
<li class="toctree-l1"><a class="reference internal" href="ins_aec.html">Instruction - Adjacency-Effect Correction</a></li>
<li class="toctree-l1"><a class="reference internal" href="ins_rho.html">Instruction - Modelling Sea-Surface Reflectance factor</a></li>
<li class="toctree-l1"><a class="reference internal" href="tmart.html">Parameters</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">T-Mart</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Instruction - Basic Modelling</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="instruction-basic-modelling">
<h1>Instruction - Basic Modelling<a class="headerlink" href="#instruction-basic-modelling" title="Permalink to this heading"></a></h1>
<p>We start with a simple setting. I will introduce new functions as we go, and have a ‘put-together’ code at the end.</p>
<p>This page walks through the input for single-wavelength and flat-surface radiative-transfer calculations.</p>
<section id="quick-start">
<h2>Quick Start<a class="headerlink" href="#quick-start" title="Permalink to this heading"></a></h2>
<p>Run T-Mart with simple settings here.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tmart</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">Py6S.Params.atmosprofile</span> <span class="kn">import</span> <span class="n">AtmosProfile</span>

<span class="c1"># Specify wavelength in nm</span>
<span class="n">wl</span> <span class="o">=</span> <span class="mi">400</span>

<span class="c1">### DEM and reflectance ###</span>

<span class="c1"># Three same-size numpy arrays are needed</span>
<span class="n">image_DEM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># in meters</span>
<span class="n">image_reflectance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">)</span> <span class="c1"># unitless     </span>
<span class="n">image_isWater</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># 1 is water, 0 is land</span>

<span class="c1"># pixel width and length, in meters </span>
<span class="n">cell_size</span> <span class="o">=</span> <span class="mi">20_000</span> 

<span class="c1"># Synthesize a surface object</span>
<span class="n">my_surface</span> <span class="o">=</span> <span class="n">tmart</span><span class="o">.</span><span class="n">Surface</span><span class="p">(</span><span class="n">DEM</span> <span class="o">=</span> <span class="n">image_DEM</span><span class="p">,</span>
                           <span class="n">reflectance</span> <span class="o">=</span> <span class="n">image_reflectance</span><span class="p">,</span>
                           <span class="n">isWater</span> <span class="o">=</span> <span class="n">image_isWater</span><span class="p">,</span>
                           <span class="n">cell_size</span> <span class="o">=</span> <span class="n">cell_size</span><span class="p">)</span>  

<span class="c1">### Atmosphere ###</span>

<span class="c1"># Atmophere profile comes from 6S</span>
<span class="n">atm_profile</span> <span class="o">=</span> <span class="n">AtmosProfile</span><span class="o">.</span><span class="n">PredefinedType</span><span class="p">(</span><span class="n">AtmosProfile</span><span class="o">.</span><span class="n">MidlatitudeSummer</span><span class="p">)</span> 

<span class="c1"># Synthesize an atmosphere object </span>
<span class="n">my_atm</span> <span class="o">=</span> <span class="n">tmart</span><span class="o">.</span><span class="n">Atmosphere</span><span class="p">(</span><span class="n">atm_profile</span><span class="p">)</span>

<span class="c1">### Running T-Mart ###</span>

<span class="c1"># Make a T-Mart object </span>
<span class="n">my_tmart</span> <span class="o">=</span> <span class="n">tmart</span><span class="o">.</span><span class="n">Tmart</span><span class="p">(</span><span class="n">Surface</span> <span class="o">=</span> <span class="n">my_surface</span><span class="p">,</span> <span class="n">Atmosphere</span><span class="o">=</span> <span class="n">my_atm</span><span class="p">)</span>

<span class="c1"># Specify the sensor&#39;s position (x, y, z), viewing direction relative </span>
<span class="c1"># to the sensor (zenith, azimuth), sun&#39;s direction relative to the target </span>
<span class="c1"># (zenith, azimuth), see Parameters for more geometry options</span>
<span class="n">my_tmart</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">sensor_coords</span><span class="o">=</span><span class="p">[</span><span class="mi">51</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">130_000</span><span class="p">],</span> 
                      <span class="n">target_pt_direction</span><span class="o">=</span><span class="p">[</span><span class="mi">180</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">sun_dir</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
	<span class="n">results</span> <span class="o">=</span> <span class="n">my_tmart</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">wl</span><span class="o">=</span><span class="n">wl</span><span class="p">)</span>
	
	<span class="c1"># Calculate reflectances using recorded photon information </span>
	<span class="n">R</span> <span class="o">=</span> <span class="n">tmart</span><span class="o">.</span><span class="n">calc_ref</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">R</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
	    <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;     &#39;</span> <span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<p>The output should be something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">=========</span> <span class="n">Initiating</span> <span class="n">T</span><span class="o">-</span><span class="n">Mart</span> <span class="o">=========</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">photons</span><span class="p">:</span> <span class="mi">10000</span>
<span class="n">Using</span> <span class="mi">10</span> <span class="n">core</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">job</span><span class="p">(</span><span class="n">s</span><span class="p">):</span> <span class="mi">80</span>
<span class="n">Wavelength</span><span class="p">:</span> <span class="mi">400</span>
<span class="n">target_pt_direction</span><span class="p">:</span> <span class="p">[</span><span class="mi">180</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">sun_dir</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="o">=====================================</span>
<span class="n">Tasks</span> <span class="n">remaining</span> <span class="o">=</span> <span class="mi">80</span>
<span class="n">Tasks</span> <span class="n">remaining</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">Tasks</span> <span class="n">remaining</span> <span class="o">=</span> <span class="mi">38</span>
<span class="n">Tasks</span> <span class="n">remaining</span> <span class="o">=</span> <span class="mi">4</span>
<span class="o">=====================================</span>
<span class="n">Calculating</span> <span class="n">reflectances</span><span class="o">...</span>
<span class="n">R_atm</span>       <span class="mf">0.1268259629342025</span>
<span class="n">R_dir</span>       <span class="mf">0.06049548401278206</span>
<span class="n">R_env</span>       <span class="mf">0.012567569504188827</span>
<span class="n">R_total</span>       <span class="mf">0.1998890164511734</span>
</pre></div>
</div>
</section>
<section id="observing-the-movements-of-a-single-photon">
<h2>Observing the Movements of a Single Photon<a class="headerlink" href="#observing-the-movements-of-a-single-photon" title="Permalink to this heading"></a></h2>
<p>Instead of running lots of photons, we can run a single photon and observe where it goes and what happens. This is mostly for debugging purposes. The details of each movement will be printed.</p>
<p>We replace Tmart’s <em>run</em> function with the <em>run_plot</em> function here, note that number of photons and multiprocessing are not needed here.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">my_tmart</span><span class="o">.</span><span class="n">run_plot</span><span class="p">(</span><span class="n">wl</span><span class="o">=</span><span class="n">wl</span><span class="p">)</span>
</pre></div>
</div>
<p>We can plot the photon’s movements by turnining on <em>plot_on</em>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">my_tmart</span><span class="o">.</span><span class="n">run_plot</span><span class="p">(</span><span class="n">wl</span><span class="o">=</span><span class="n">wl</span><span class="p">,</span> <span class="n">plot_on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>By default, the limits of X, Y, Z are all 0 to 100,000. We can specify them in the format of [xmin, xmax, ymin, ymax, zmin, zmax]:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">my_tmart</span><span class="o">.</span><span class="n">run_plot</span><span class="p">(</span><span class="n">wl</span><span class="o">=</span><span class="n">wl</span><span class="p">,</span> <span class="n">plot_on</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">100_000</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">100_000</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">100_000</span><span class="p">])</span>
</pre></div>
</div>
<p>Lastly, to switch to an interactive plotting mode where you can zoom and rotate the camera interactively, and switch back, use:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Interactive mode</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">qt</span>

<span class="c1"># Inline plotting </span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</pre></div>
</div>
<p>Putting it all together. We can still calculate reflectances using one photon thanks to the local-estimate technique, but this is not accurate - precise stats come from a large sample size.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tmart</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">Py6S.Params.atmosprofile</span> <span class="kn">import</span> <span class="n">AtmosProfile</span>

<span class="c1"># Specify wavelength in nm</span>
<span class="n">wl</span> <span class="o">=</span> <span class="mi">400</span>

<span class="c1">### DEM and reflectance ###</span>

<span class="c1"># Three same-size numpy arrays are needed</span>
<span class="n">image_DEM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># in meters</span>
<span class="n">image_reflectance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">)</span> <span class="c1"># unitless     </span>
<span class="n">image_isWater</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># 1 is water, 0 is land</span>

<span class="c1"># pixel width and length, in meters </span>
<span class="n">cell_size</span> <span class="o">=</span> <span class="mi">20_000</span> 

<span class="c1"># Synthesize a surface object</span>
<span class="n">my_surface</span> <span class="o">=</span> <span class="n">tmart</span><span class="o">.</span><span class="n">Surface</span><span class="p">(</span><span class="n">DEM</span> <span class="o">=</span> <span class="n">image_DEM</span><span class="p">,</span>
                           <span class="n">reflectance</span> <span class="o">=</span> <span class="n">image_reflectance</span><span class="p">,</span>
                           <span class="n">isWater</span> <span class="o">=</span> <span class="n">image_isWater</span><span class="p">,</span>
                           <span class="n">cell_size</span> <span class="o">=</span> <span class="n">cell_size</span><span class="p">)</span>  

<span class="c1">### Atmosphere ###</span>

<span class="c1"># Atmophere profile comes from 6S</span>
<span class="n">atm_profile</span> <span class="o">=</span> <span class="n">AtmosProfile</span><span class="o">.</span><span class="n">PredefinedType</span><span class="p">(</span><span class="n">AtmosProfile</span><span class="o">.</span><span class="n">MidlatitudeSummer</span><span class="p">)</span> 

<span class="c1"># Synthesize an atmosphere object </span>
<span class="n">my_atm</span> <span class="o">=</span> <span class="n">tmart</span><span class="o">.</span><span class="n">Atmosphere</span><span class="p">(</span><span class="n">atm_profile</span><span class="p">)</span>

<span class="c1">### Running T-Mart ###</span>

<span class="c1"># Make a T-Mart object </span>
<span class="n">my_tmart</span> <span class="o">=</span> <span class="n">tmart</span><span class="o">.</span><span class="n">Tmart</span><span class="p">(</span><span class="n">Surface</span> <span class="o">=</span> <span class="n">my_surface</span><span class="p">,</span> <span class="n">Atmosphere</span><span class="o">=</span> <span class="n">my_atm</span><span class="p">)</span>

<span class="c1"># Specify the sensor&#39;s position (x, y, z), viewing direction relative </span>
<span class="c1"># to the sensor (zenith, azimuth), sun&#39;s direction relative to the target </span>
<span class="c1"># (zenith, azimuth)</span>
<span class="n">my_tmart</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">sensor_coords</span><span class="o">=</span><span class="p">[</span><span class="mi">51</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">130_000</span><span class="p">],</span> 
                      <span class="n">target_pt_direction</span><span class="o">=</span><span class="p">[</span><span class="mi">180</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">sun_dir</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Run and plot on a separate window</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">qt</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">my_tmart</span><span class="o">.</span><span class="n">run_plot</span><span class="p">(</span><span class="n">wl</span><span class="o">=</span><span class="n">wl</span><span class="p">,</span> <span class="n">plot_on</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">100_000</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">100_000</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">100_000</span><span class="p">])</span>

<span class="c1"># Calculate reflectances using recorded photon information </span>
<span class="n">R</span> <span class="o">=</span> <span class="n">tmart</span><span class="o">.</span><span class="n">calc_ref</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">R</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;     &#39;</span> <span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<p>Here’s the first plot generated by the code above, the following ones are not shown here. Our input numpy array has a shape of (2,2) but we are seeing 4*4 pixels. This is because the input numpy arrays were padded by 1 layer that connect the input surface to the background in case of an elevation difference between the two.
<img alt="Geometry" src="_images/movement.png" /></p>
<p>There are lines of different colours in the plot:</p>
<ul class="simple">
<li><p>Blue to red: the photon moves from blue to red.</p></li>
<li><p>Green: surface normal of a Lambertian surface.</p></li>
<li><p>Dark blue: surface normal of a specular surface.</p></li>
<li><p>Orange: next moving direction</p></li>
</ul>
</section>
<section id="multiple-processing">
<h2>Multiple Processing<a class="headerlink" href="#multiple-processing" title="Permalink to this heading"></a></h2>
<p>Monte Carlo simulations have inherent noise - it decreases with a larger sample size. Multiprocessing is used to speed up the computation.</p>
<p>By default, 10,000 photons are used. The number of CPU cores to use is automatic but can be modified. Default number of jobs is 80. Use 100,000 photons for more stable results (it can take up to several minutes for a single computation).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Number of photons</span>
<span class="n">n_photon</span> <span class="o">=</span> <span class="mi">100_000</span>

<span class="c1"># Number of CPU cores to use, sometimes default doesn&#39;t work and </span>
<span class="c1"># you need to specify the number of cores you have. </span>
<span class="n">nc</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># Dividing the task into n jobs, I found 80-120 lead to </span>
<span class="c1"># more or less the same processing time. </span>
<span class="n">njobs</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">my_tmart</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">wl</span><span class="o">=</span><span class="n">wl</span><span class="p">,</span> <span class="n">n_photon</span><span class="o">=</span><span class="n">n_photon</span><span class="p">,</span><span class="n">nc</span><span class="o">=</span> <span class="n">nc</span><span class="p">,</span><span class="n">njobs</span><span class="o">=</span> <span class="n">njobs</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="water-pixels">
<h2>Water Pixels<a class="headerlink" href="#water-pixels" title="Permalink to this heading"></a></h2>
<p>From here we go back to multiprocessing lots of photons.</p>
<p>We can change the pixels from land to water by specifying the water pixels in the image_isWater numpy array:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 0 is non-water, 1 is water</span>
<span class="n">image_isWater</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
</pre></div>
</div>
</section>
<section id="modify-background">
<h2>Modify Background<a class="headerlink" href="#modify-background" title="Permalink to this heading"></a></h2>
<p>By default, the background surface takes the average reflectance of the pixels and an elevation of 0.</p>
<p>A total of two background surfaces can be specified to model coastal environments, they are divided by a line connected by two specified coordinates (<em>bg_coords</em>). We can modify the reflectance and if-is-water of each of the two background surfaces. We can modify the elevation of the background too, but both background surfaces will share the same elevation (to avoid gaps in between).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set background information, 1 or 2 background surfaces can be set;</span>
<span class="c1"># If 2: the first background is the one closer to [0,0]</span>
<span class="n">my_surface</span><span class="o">.</span><span class="n">set_background</span><span class="p">(</span><span class="n">bg_ref</span>        <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span> <span class="c1"># background reflectance</span>
                          <span class="n">bg_isWater</span>    <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># if is water</span>
                          <span class="n">bg_elevation</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># elevation of both background</span>
                          <span class="n">bg_coords</span>     <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">]])</span> <span class="c1"># a line dividing the two background                                    </span>
</pre></div>
</div>
</section>
<section id="adding-aerosol-to-the-atmosphere">
<h2>Adding Aerosol to the Atmosphere<a class="headerlink" href="#adding-aerosol-to-the-atmosphere" title="Permalink to this heading"></a></h2>
<p>Add aerosol model and AOT550. All aerosol models in 6S are included in T-Mart. An atmosphere object is not wavelength-dependent. It is valid between 350nm and 3750nm</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Atmophere </span>
<span class="n">atm_profile</span> <span class="o">=</span> <span class="n">AtmosProfile</span><span class="o">.</span><span class="n">PredefinedType</span><span class="p">(</span><span class="n">AtmosProfile</span><span class="o">.</span><span class="n">MidlatitudeSummer</span><span class="p">)</span> 
<span class="n">aerosol_type</span> <span class="o">=</span> <span class="s1">&#39;Maritime&#39;</span> 
<span class="n">aot550</span> <span class="o">=</span> <span class="mf">0.1</span>   
<span class="n">my_atm</span> <span class="o">=</span> <span class="n">tmart</span><span class="o">.</span><span class="n">Atmosphere</span><span class="p">(</span><span class="n">atm_profile</span><span class="p">,</span> <span class="n">aot550</span><span class="p">,</span> <span class="n">aerosol_type</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="surface-properties">
<h2>Surface Properties<a class="headerlink" href="#surface-properties" title="Permalink to this heading"></a></h2>
<p>Once we have the Tmart object, we can modify wind and water properties. They are both related to the specular reflectance of the water surface.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># wind_dir is the wind direction clockwise from the X axis, 0 means upwind </span>
<span class="c1"># along the X axis (X+), AKA where the wind comes from</span>
<span class="n">my_tmart</span><span class="o">.</span><span class="n">set_wind</span><span class="p">(</span><span class="n">wind_speed</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">wind_dir</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># More commonly, we don&#39;t know where the wind direction; in this case, </span>
<span class="c1"># we can set wind direction to azimuthal average. </span>
<span class="n">my_tmart</span><span class="o">.</span><span class="n">set_wind</span><span class="p">(</span><span class="n">wind_speed</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">wind_azi_avg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Water salinity in parts per thousand and temperature in celsius</span>
<span class="n">my_tmart</span><span class="o">.</span><span class="n">set_water</span><span class="p">(</span><span class="n">water_salinity</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">water_temperature</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="band-calculation">
<h2>Band Calculation<a class="headerlink" href="#band-calculation" title="Permalink to this heading"></a></h2>
<p>Band calculation is possible. All the built-in bands in Py6S can be used as T-Mart takes the same band input as Py6S. However, a central wavelength is still required for interpolation of water and aerosol properties (some not in Py6S).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Band 2 of Sentinel-2A and its central wavelength</span>
<span class="n">band</span> <span class="o">=</span> <span class="n">Py6S</span><span class="o">.</span><span class="n">Wavelength</span><span class="p">(</span><span class="n">Py6S</span><span class="o">.</span><span class="n">PredefinedWavelengths</span><span class="o">.</span><span class="n">S2A_MSI_02</span><span class="p">)</span>
<span class="n">wl</span> <span class="o">=</span> <span class="mi">490</span> 
</pre></div>
</div>
</section>
<section id="other-parameters">
<h2>Other Parameters<a class="headerlink" href="#other-parameters" title="Permalink to this heading"></a></h2>
<p>Set the number of atmosphere layers and aerosol scale height. T-Mart can calculate the movement of a photon through multiple layers at once so having lots of layers (e.g., 20 by default) does not slow down the computation significantly. Aerosol scale height is 2km by default and it can be modified too.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">n_layers</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">aerosol_scale_height</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Unless you have a reason, don&#39;t change this</span>
<span class="n">my_atm</span> <span class="o">=</span> <span class="n">tmart</span><span class="o">.</span><span class="n">Atmosphere</span><span class="p">(</span><span class="n">atm_profile</span><span class="p">,</span> <span class="n">aot550</span><span class="p">,</span> <span class="n">aerosol_type</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">aerosol_scale_height</span><span class="p">)</span>
</pre></div>
</div>
<p>Enable shadow in computation. This adds a test in calculating TOA-radiance contribution for every photon. If a photon is blocked from the sun by the terrain, the contribution will be 0.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_tmart</span> <span class="o">=</span> <span class="n">tmart</span><span class="o">.</span><span class="n">Tmart</span><span class="p">(</span><span class="n">Surface</span> <span class="o">=</span> <span class="n">my_surface</span><span class="p">,</span> <span class="n">Atmosphere</span><span class="o">=</span> <span class="n">my_atm</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Print detailed reflectances that further divided the environmental and direct reflectances into contributions from water-leaving, water-specular, water-whitecap and land reflectances.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">R</span> <span class="o">=</span> <span class="n">tmart</span><span class="o">.</span><span class="n">calc_ref</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="full-single-run">
<h2>Full Single Run<a class="headerlink" href="#full-single-run" title="Permalink to this heading"></a></h2>
<p>Now we can put everything together. Below is the code I usually use for my single runs (different components of TOA reflectance at a single wavelength in a single scenario, but with lots of photons).</p>
<p>The setting of this run:</p>
<ul class="simple">
<li><p>Band: Sentinel-2A Band 2</p></li>
<li><p>Surface: Homogeneous water with a water-leaving reflectance of 0.1 at this band</p></li>
<li><p>Atmosphere: mid-latitude summer</p></li>
<li><p>Aerosol: maritime aerosol with an AOT of 0.1 at 550nm</p></li>
<li><p>Elevation: sea level</p></li>
<li><p>Wind: azimuthally averaged wind with a windspeed of 5m/s</p></li>
<li><p>Solar angle: nadir</p></li>
<li><p>Viewing angle: nadir</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tmart</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">Py6S.Params.atmosprofile</span> <span class="kn">import</span> <span class="n">AtmosProfile</span>
<span class="kn">import</span> <span class="nn">Py6S</span>

<span class="c1"># Band 2 of Sentinel-2A and its central wavelength</span>
<span class="n">band</span> <span class="o">=</span> <span class="n">Py6S</span><span class="o">.</span><span class="n">Wavelength</span><span class="p">(</span><span class="n">Py6S</span><span class="o">.</span><span class="n">PredefinedWavelengths</span><span class="o">.</span><span class="n">S2A_MSI_02</span><span class="p">)</span>
<span class="n">wl</span> <span class="o">=</span> <span class="mi">490</span> 

<span class="c1">### DEM and reflectance ###</span>

<span class="c1"># Three same-size numpy arrays are needed</span>
<span class="n">image_DEM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># in meters</span>
<span class="n">image_reflectance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">)</span> <span class="c1"># unitless     </span>
<span class="n">image_isWater</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># 1 is water, 0 is land</span>

<span class="c1"># pixel width and length, in meters </span>
<span class="n">cell_size</span> <span class="o">=</span> <span class="mi">20_000</span> 

<span class="c1"># Synthesize a surface object</span>
<span class="n">my_surface</span> <span class="o">=</span> <span class="n">tmart</span><span class="o">.</span><span class="n">Surface</span><span class="p">(</span><span class="n">DEM</span> <span class="o">=</span> <span class="n">image_DEM</span><span class="p">,</span>
                           <span class="n">reflectance</span> <span class="o">=</span> <span class="n">image_reflectance</span><span class="p">,</span>
                           <span class="n">isWater</span> <span class="o">=</span> <span class="n">image_isWater</span><span class="p">,</span>
                           <span class="n">cell_size</span> <span class="o">=</span> <span class="n">cell_size</span><span class="p">)</span>  
<span class="c1"># Set background information, 1 or 2 background surfaces can be set;</span>
<span class="c1"># If 2: the first background is the one closer to [0,0]</span>
<span class="n">my_surface</span><span class="o">.</span><span class="n">set_background</span><span class="p">(</span><span class="n">bg_ref</span>        <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span> <span class="c1"># background reflectance</span>
                          <span class="n">bg_isWater</span>    <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># if is water</span>
                          <span class="n">bg_elevation</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># elevation of both background</span>
                          <span class="n">bg_coords</span>     <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">]])</span> <span class="c1"># a line dividing the two background                                    </span>

<span class="c1">### Atmosphere ###</span>

<span class="c1"># Atmophere profile comes from 6S</span>
<span class="n">atm_profile</span> <span class="o">=</span> <span class="n">AtmosProfile</span><span class="o">.</span><span class="n">PredefinedType</span><span class="p">(</span><span class="n">AtmosProfile</span><span class="o">.</span><span class="n">MidlatitudeSummer</span><span class="p">)</span> 
<span class="n">aerosol_type</span> <span class="o">=</span> <span class="s1">&#39;Maritime&#39;</span> 
<span class="n">aot550</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">n_layers</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">aerosol_scale_height</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Unless you have a reason, don&#39;t change this</span>

<span class="c1"># Synthesize an atmosphere object    </span>
<span class="n">my_atm</span> <span class="o">=</span> <span class="n">tmart</span><span class="o">.</span><span class="n">Atmosphere</span><span class="p">(</span><span class="n">atm_profile</span><span class="p">,</span> <span class="n">aot550</span><span class="p">,</span> <span class="n">aerosol_type</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">aerosol_scale_height</span><span class="p">)</span>

<span class="c1">### Running T-Mart ###</span>

<span class="c1"># Make a T-Mart object </span>
<span class="n">my_tmart</span> <span class="o">=</span> <span class="n">tmart</span><span class="o">.</span><span class="n">Tmart</span><span class="p">(</span><span class="n">Surface</span> <span class="o">=</span> <span class="n">my_surface</span><span class="p">,</span> <span class="n">Atmosphere</span><span class="o">=</span> <span class="n">my_atm</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">my_tmart</span><span class="o">.</span><span class="n">set_wind</span><span class="p">(</span><span class="n">wind_speed</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">wind_azi_avg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">my_tmart</span><span class="o">.</span><span class="n">set_water</span><span class="p">(</span><span class="n">water_salinity</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">water_temperature</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># Specify the sensor&#39;s position (x, y, z), viewing direction relative </span>
<span class="c1"># to the sensor (zenith, azimuth), sun&#39;s direction relative to the target </span>
<span class="c1"># (zenith, azimuth), see Parameters for more geometry options</span>
<span class="n">my_tmart</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">sensor_coords</span><span class="o">=</span><span class="p">[</span><span class="mi">51</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">130_000</span><span class="p">],</span> 
                      <span class="n">target_pt_direction</span><span class="o">=</span><span class="p">[</span><span class="mi">180</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">sun_dir</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Number of photons</span>
<span class="n">n_photon</span> <span class="o">=</span> <span class="mi">10_000</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
	<span class="n">results</span> <span class="o">=</span> <span class="n">my_tmart</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">wl</span><span class="o">=</span><span class="n">wl</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span> <span class="n">n_photon</span><span class="o">=</span><span class="n">n_photon</span><span class="p">)</span>
	<span class="c1"># Calculate reflectances using recorded photon information </span>
	<span class="n">R</span> <span class="o">=</span> <span class="n">tmart</span><span class="o">.</span><span class="n">calc_ref</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">R</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
	    <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;     &#39;</span> <span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<p>The output should be something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">=========</span> <span class="n">Initiating</span> <span class="n">T</span><span class="o">-</span><span class="n">Mart</span> <span class="o">=========</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">photons</span><span class="p">:</span> <span class="mi">10000</span>
<span class="n">Using</span> <span class="mi">10</span> <span class="n">core</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">job</span><span class="p">(</span><span class="n">s</span><span class="p">):</span> <span class="mi">80</span>
<span class="n">Wavelength</span><span class="p">:</span> <span class="mi">490</span>
<span class="n">target_pt_direction</span><span class="p">:</span> <span class="p">[</span><span class="mi">180</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">sun_dir</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="o">=====================================</span>
<span class="n">Tasks</span> <span class="n">remaining</span> <span class="o">=</span> <span class="mi">80</span>
<span class="n">Tasks</span> <span class="n">remaining</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">Tasks</span> <span class="n">remaining</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">Tasks</span> <span class="n">remaining</span> <span class="o">=</span> <span class="mi">20</span>
<span class="o">=====================================</span>
<span class="n">Calculating</span> <span class="n">reflectances</span><span class="o">...</span>
<span class="n">R_atm</span>       <span class="mf">0.06893881541307002</span>
<span class="n">R_dir</span>       <span class="mf">0.1379497814430936</span>
<span class="n">_R_dir_coxmunk</span>       <span class="mf">0.06642816059303165</span>
<span class="n">_R_dir_whitecap</span>       <span class="mf">0.0006626906106484629</span>
<span class="n">_R_dir_water</span>       <span class="mf">0.07085893023941349</span>
<span class="n">_R_dir_land</span>       <span class="mf">0.0</span>
<span class="n">R_env</span>       <span class="mf">0.019385220352836064</span>
<span class="n">_R_env_coxmunk</span>       <span class="mf">0.005913541575192834</span>
<span class="n">_R_env_whitecap</span>       <span class="mf">0.0001248231643733515</span>
<span class="n">_R_env_water</span>       <span class="mf">0.013346855613269877</span>
<span class="n">_R_env_land</span>       <span class="mf">0.0</span>
<span class="n">R_total</span>       <span class="mf">0.2262738172089997</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="overview.html" class="btn btn-neutral float-left" title="Overview" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="ins_advanced.html" class="btn btn-neutral float-right" title="Instruction - Advanced Modelling" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Yulun Wu.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>